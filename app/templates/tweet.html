<!-- extend base layout -->
{% extends "base.html" %}

{% block content %}
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <style>
      .axis path, .axis line
        {
            fill: none;
            stroke: #777;
            shape-rendering: crispEdges;
        }
        
        .axis text
        {
            font-family: 'Arial';
            font-size: 13px;
        }
        .tick
        {
            stroke-dasharray: 1, 2;
        }
        .bar
        {
            fill: FireBrick;
        }
        .word {
            display: inline;
            padding: 0px 1px 0px 1px;
            max-width: 60%;
            position: relative;
            opacity: 1;
            z-index: 999;
        }
      .genertweet {
        margin-right: auto;
        margin-left:auto;
        margin-top: 10px;
        min-height: 370px;
        padding: 10px;
        /*position: relative;*/
        display: inline-flex;
        background-size: cover;
        color: white;
        overflow: hidden;
        text-align: center;
        width: 90%;
      }
      #genertext {
        padding: 0px 130px 15px;
        line-height: 1;
        vertical-align: middle;
        margin: auto;
      }
      .scrape_image {
        z-index: 1;
        position: absolute;
        text-align: center;
        vertical-align: middle;
        margin: 0 auto;
        padding: 0;
        opacity: 0.5;
        background-size: cover;
      }
      .genertweet p {
        margin: 0;
        position: absolute;
        width: 100%;
        height: 100%;
        color: white;
        text-align:left;
        opacity: 1;
        z-index:999;
        font-size: 14px;
      }
      .genertweet h3 {
        position: relative;
        text-align: center;
        display: inline;
        vertical-align: middle;
        line-height: 2; 
        font-size: 30px;
        font-family: 'Fjalla One';
        opacity: 1;
        z-index: 999;
      }
      .background_image {
           height: auto;
           left: 0;
           margin: 0;
           min-width: 674px;
           padding: 0;
           position: absolute;
           top: 0;
           width: 100%;
           z-index: -1;
           background-size: cover;
        }
        .origtweet {
            margin: -35px 0px 0px;
            line-height:1.2;
            display:inline;
            font-size:16px;
        }
        .origtweet p {
            text-align: left;
            margin: 7px 0;
        }
        .origtweet span {
            text-align: right;
            margin: 0 10px;
        }
    </style>

    <div class="genertweet">

        <div class="background_image">
        </div>
            <p>
               Your tweet referenced {{ num_ref }} original tweets. Hover over the words to see where they came from.
            </p>
            <div id="genertext">
                {% for word in tweet %}
            	<div class="word" id={{ word[1] }} text={{ word[0] }}><h3> {{ word[0] }} </h3></div>
                {% endfor %}
            </div>
    </div>
    <div class="origtweet">
    </div>

    <div class="plot_word">

    </div>

    <script type="text/javascript" >
        // load data
        var references = {{ references|tojson }};
        var tweet_list = {{ tweet|tojson }};
        var back_img = {{ back_img|tojson }};
        console.log(references);
        var the_word;

        show_img = '<img class="background_image back-up" style="opacity:0.6;" src="static/trump.jpg" border="0" alt="">'
        // backup images
        for (i=0;i<back_img.length;i++){
            show_img += '<img class="background_image" style="opacity:0.3;" id="' + i + '" src=' + back_img[i] + ' border="0" alt="">'
        }
        // scraped images
        /*for (var key_name in references) {
            the_word = key_name;
            for (j=0;j<references[the_word].imgs.length;j++){
                show_img += '<img class="background_image '+the_word+'"" style="opacity:0;" " src=' + references[the_word].imgs[j] + ' border="0" alt="">'
            }
        }*/
        console.log(show_img);
        $('.background_image').html(show_img);
        var img_in, img_out;
        img_in = "back-up";

        // initialize the_word, prev_img, show_orig
        var prev_img = ''; 
        var show_orig = '<p></p>';
        $('.origtweet').html(show_orig);
        console.log(the_word);

        // mouse-over the_word
        $('.word').mouseover(function(){
            // get the word and update orig_tweet html
            the_word = $(this).attr('id');
            console.log($(this).attr('text'));
            console.log(references[the_word].words_used);
            show_orig = '<p>On '+references[the_word].orig_date+' at '+references[the_word].orig_time+', Trump tweeted: <em>'+references[the_word].orig_text+'</em></p><p>Image searched key terms: <em>'+ references[the_word].imp_words.join(', ')+'</em><span>Your tweet borrowed: <em>'+references[the_word].words_used.join(', ')+'</em></span></p>'
            $('.origtweet').html(show_orig);

            /*img_out = img_in;
            img_in = the_word; 
            opacity = 0.6/references[the_word].imgs.length;
            if (references[the_word].imgs.length==0){
                img_in = "back-up";
                opacity = 0.6;
            }
            if (img_in != img_out){
                $('.'+img_out).attr("style","opacity:"+0+";");
                console.log("image out "+ img_out);
            }
            $('.'+img_in).attr("style","opacity:"+opacity+";");
            console.log(references[the_word].imp_words);
            console.log(references[the_word].imgs);
            console.log(opacity);
            console.log("image in "+img_in);*/
        });

        $('.word').click(function(){
            // get the word and update orig_tweet html
            search_word = $(this).attr('text').toLowerCase().replace(":", "").replace(".", "").replace(",", "").replace("?", "").replace("!", "").replace('"', '');
            console.log(search_word);
            $('.plot_word').html('<svg id="visualisation" width="1000" height="500"></svg>');

            InitChart();

            function InitChart() {

              var allData = {{ counts|tojson }};
              var wordData = allData[search_word];
              var barData = wordData[1];
              console.log(wordData);
              console.log(barData);

              var vis = d3.select('#visualisation'),
                WIDTH = 1000,
                HEIGHT = 400,
                MARGINS = {
                  top: 20,
                  right: 20,
                  bottom: 20,
                  left: 50
                },
                xRange = d3.scale.ordinal().rangeRoundBands([MARGINS.left, WIDTH - MARGINS.right], 0.1).domain(barData.map(function (d) {
                  return d.x;
                })),


                yRange = d3.scale.linear().range([HEIGHT - MARGINS.top, MARGINS.bottom]).domain([0,
                  d3.max(barData, function (d) {
                    return d.y;
                  })
                ]),

                xAxis = d3.svg.axis()
                    .tickFormat(function(d) { 

                                if(d%100==1){ 
                                    return Math.floor(d/100)}

                                else{ 
                                    return }
                            })    
                  .scale(xRange)
                  .tickSize(5)
                  .tickSubdivide(true)
                  .ticks(10),

                yAxis = d3.svg.axis()
                  .scale(yRange)
                  .tickSize(5)
                  .orient("left")
                  .tickSubdivide(true);

                  vis.append('svg:g')
                    .attr('class', 'x axis')
                    .attr('transform', 'translate(0,' + (HEIGHT - MARGINS.bottom) + ')')
                    .call(xAxis);

                  vis.append('svg:g')
                    .attr('class', 'y axis')
                    .attr('transform', 'translate(' + (MARGINS.left) + ',0)')
                    .call(yAxis);

                  vis.selectAll('rect')
                    .data(barData)
                    .enter()
                    .append('rect')
                    .attr('x', function (d) {
                      return xRange(d.x);
                    })
                    .attr('y', function (d) {
                      return yRange(d.y);
                    })
                    .attr('width', xRange.rangeBand())
                    .attr('height', function (d) {
                      return ((HEIGHT - MARGINS.bottom) - yRange(d.y));
                    })
                    .attr('fill', 'grey')
                    .on('mouseover',function(d){
                      d3.select(this)
                        .attr('fill','blue');
                    })
                    .on('mouseout',function(d){
                      d3.select(this)
                        .attr('fill','grey');
                    });

            }
        });
    </script>
{% endblock %}
